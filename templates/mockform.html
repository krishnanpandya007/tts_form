<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Form</title>
    <style>
      *{
        padding: 0;
        margin: 0;
      }  
      body{
        padding: 2rem;
      }
    </style>
</head>
<body>
    <form method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        <input hidden type="text" name="currentField" value="{{ targetField }}" id="currentField">
        <input hidden type="text" name="direction" value="next" id="direction">
        <div class="parent">
            <input type="text" name="label-name" value="{% if name != False %}{{ name }}{% endif %}" id="name">
            <b>Your Name</b>
            {% if name_error %}
            <b style="color: red">Error parsing text, Could you please try again</b>
            {% endif %}
            <input accept="audio/wav" type="file" hidden name="name_audio" id="name_audio">
            <a style="background-color: aquamarine; padding: 1rem 1.5rem;border-radius: 10px;" id="record_name">Hold to Record</a>
            <br/>
            <button onclick="prevButton()">Previous</button>
            <button onclick="nextButton()">Next</button>
        </div>

        <div class="parent">
            <input type="text" name="label-district" value="{{ district }}" id="district">
            <b>Your District</b>
            {% if district_error %}
            <b style="color: red">Error parsing text, Could you please try again</b>
            {% endif %}
            <input accept="audio/wav" type="file" hidden name="district_audio" id="district_audio">
            <a style="background-color: aquamarine; padding: 1rem 1.5rem;border-radius: 10px;" id="record_name">Hold to Record</a>
            <br/>
            <button onclick="prevButton()">Previous</button>
            <button onclick="nextButton()">Next</button>
        </div>

      <div class="parent">
          <input type="text" name="label-city" value="{{ city }}" id="city">
          <b>Your City</b>
          {% if city_error %}
          <b style="color: red">Error parsing text, Could you please try again</b>
          {% endif %}
          <input accept="audio/wav" type="file" hidden name="city_audio" id="city_audio">
          <a style="background-color: aquamarine; padding: 1rem 1.5rem;border-radius: 10px;" id="record_name">Hold to Record</a>
          <br/>
          <button onclick="prevButton()">Previous</button>
          <button onclick="nextButton()">Next</button>
      </div>

    <div class="parent">
        <input type="text" name="label-phone" value="{{ phone }}" id="phone">
        <b>Your Phone</b>
        {% if phone_error %}
        <b style="color: red">Error parsing text, Could you please try again</b>
        {% endif %}
        <input accept="audio/wav" type="file" hidden name="phone_audio" id="phone_audio">
        <a style="background-color: aquamarine; padding: 1rem 1.5rem;border-radius: 10px;" id="record_name">Hold to Record</a>
        <br/>
        <button onclick="prevButton()">Previous</button>
        <button onclick="nextButton()">Next</button>
    </div>
    </form>
    <script src="https://cdn.rawgit.com/mattdiamond/Recorderjs/08e7abd9/dist/recorder.js"></script>
    <script>
      document.getElementById('name').value = "{{ name }}"
      function nextButton() {

        document.getElementById('direction').value = 'next';

        return true;

      }

      function prevButton() {

        document.getElementById('direction').value = 'prev';

        return true;

      }

      let currentField = "{{ targetField }}"
      let ds = document.getElementsByClassName('parent')
      console.log("ASD", ds, currentField);
      for(let i = 0; i < ds.length; i++){
        if(ds[i].children[0].id !== currentField){
        console.log("ASDee", ds);

          ds[i].style.display = "none";
        }
      }

        let record_button = document.getElementById('record_name');
        let name_audio_input = document.getElementById('name_audio');
        var recorder;
        // let recorder = Recorder();
        record_button.addEventListener('mousedown', (e) => {
            startRecording();


        })
        record_button.addEventListener('mouseup', (e) => {

            stopRecording();
            e.preventDefault();
            return false
        })

        function startRecording() {

      var constraints = { audio: true };

      navigator.mediaDevices.getUserMedia(constraints)
        .then(function(stream) {
          audioStream = stream;
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
          var input = audioContext.createMediaStreamSource(stream);
          recorder = new Recorder(input, {
            numChannels: 1, // Set to 1 for mono recording
            sampleRate: 104100, // Set the desired sample rate (44100 Hz by default)
            bitRate: 928000 // Set the desired bitrate (128000 bps by default)
          });
          recorder.record();
        })
        .catch(function(err) {
          console.error('Error accessing microphone: ' + err);
        });
    }

    function stopRecording() {

      recorder.stop();
      audioStream.getAudioTracks()[0].stop();
      recorder.exportWAV(function(blob) {
        let file = new File([blob], "rec.wav",{ lastModified:new Date().getTime()});
        let container = new DataTransfer();
        container.items.add(file);
        console.log(container.files[0]);
        console.log(name_audio_input);
        name_audio_input.files = container.files;
        // var url = URL.createObjectURL(blob);
        // downloadButton.href = url;
      });
      
      recorder.clear();
    }

</script>
</body>
</html>